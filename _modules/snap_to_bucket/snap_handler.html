
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>snap_to_bucket.snap_handler &#8212; snap_to_bucket 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for snap_to_bucket.snap_handler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SPDX-FileCopyrightText: Siemens AG, 2020 Gaurav Mishra &lt;mishra.gaurav@siemens.com&gt;</span>

<span class="sd">SPDX-License-Identifier: MIT</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Siemens AG&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">snap_to_bucket</span> <span class="kn">import</span> <span class="n">Ec2Handler</span>
<span class="kn">from</span> <span class="nn">snap_to_bucket</span> <span class="kn">import</span> <span class="n">S3Handler</span>
<span class="kn">from</span> <span class="nn">snap_to_bucket</span> <span class="kn">import</span> <span class="n">FsHandler</span>


<div class="viewcode-block" id="SnapToBucket"><a class="viewcode-back" href="../../snap_to_bucket.snap_handler.html#snap_to_bucket.snap_handler.SnapToBucket">[docs]</a><span class="k">class</span> <span class="nc">SnapToBucket</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class of the tool</span>

<span class="sd">    :ivar bucket: Bucket to use</span>
<span class="sd">    :ivar tag: Tag of snapshots for filtering</span>
<span class="sd">    :ivar verbose: Verbosity level (0-3)</span>
<span class="sd">    :ivar volume_type: Type of new EBS volume to use</span>
<span class="sd">    :ivar storage_class: Storage class of S3 object</span>
<span class="sd">    :ivar mount_point: Mount point to mount new volumes to</span>
<span class="sd">    :ivar delete_snap: True to delete snapshot after migration</span>
<span class="sd">    :ivar restore: Is this a restore request?</span>
<span class="sd">    :ivar restore_key: Key of the tar to be restored</span>
<span class="sd">    :ivar restore_boot: Was the snapshot, being restored, bootable?</span>
<span class="sd">    :ivar split_size: Size in bytes to split tar at</span>
<span class="sd">    :ivar gzip: True to compress tar with gzip</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;snap-to-bucket&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">volume_type</span><span class="o">=</span><span class="s2">&quot;gp2&quot;</span><span class="p">,</span> <span class="n">storage_class</span><span class="o">=</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span>
                 <span class="n">mount_point</span><span class="o">=</span><span class="s2">&quot;/mnt/snaps&quot;</span><span class="p">,</span> <span class="n">delete_snap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">restore_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">restore_boot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for the class attributes.</span>

<span class="sd">        :param bucket: Bucket to use</span>
<span class="sd">        :type bucket: string</span>
<span class="sd">        :param tag: Tag of snapshots for filtering</span>
<span class="sd">        :type tag: string</span>
<span class="sd">        :param verbose: Verbosity level (0-3)</span>
<span class="sd">        :type verbose: integer</span>
<span class="sd">        :param volume_type: Type of new EBS volume to use</span>
<span class="sd">        :type volume_type: string</span>
<span class="sd">        :param storage_class: Storage class of S3 object</span>
<span class="sd">        :type storage_class: string</span>
<span class="sd">        :param mount_point: Mount point to mount new volumes to</span>
<span class="sd">        :type mount_point: string</span>
<span class="sd">        :param delete_snap: True to delete snapshot after migration</span>
<span class="sd">        :type delete_snap: boolean</span>
<span class="sd">        :param restore: Is this a restore request?</span>
<span class="sd">        :type restore: boolean</span>
<span class="sd">        :param restore_key: Key of the tar to be restored</span>
<span class="sd">        :type restore_key: string</span>
<span class="sd">        :param restore_boot: Was the snapshot, being restored, bootable?</span>
<span class="sd">        :type restore_boot: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bucket</span> <span class="o">=</span> <span class="n">bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="k">if</span> <span class="n">volume_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;io1&#39;</span><span class="p">,</span> <span class="s1">&#39;gp2&#39;</span><span class="p">,</span> <span class="s1">&#39;sc1&#39;</span><span class="p">,</span> <span class="s1">&#39;st1&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__volume_type</span> <span class="o">=</span> <span class="n">volume_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized volume type </span><span class="si">{</span><span class="n">volume_type</span><span class="si">}</span><span class="s2"> passed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">storage_class</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STANDARD&#39;</span><span class="p">,</span> <span class="s1">&#39;REDUCED_REDUNDANCY&#39;</span><span class="p">,</span> <span class="s1">&#39;STANDARD_IA&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;ONEZONE_IA&#39;</span><span class="p">,</span> <span class="s1">&#39;GLACIER&#39;</span><span class="p">,</span> <span class="s1">&#39;INTELLIGENT_TIERING&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;DEEP_ARCHIVE&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__storage_class</span> <span class="o">=</span> <span class="n">storage_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized storage class </span><span class="si">{</span><span class="n">storage_class</span><span class="si">}</span><span class="s2"> passed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mount_point</span> <span class="o">=</span> <span class="n">mount_point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_snap</span> <span class="o">=</span> <span class="n">delete_snap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__restore</span> <span class="o">=</span> <span class="n">restore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__restore_key</span> <span class="o">=</span> <span class="n">restore_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__restore_boot</span> <span class="o">=</span> <span class="n">restore_boot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__split_size</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mf">1024.0</span> <span class="o">*</span> <span class="mf">1024.0</span> <span class="o">*</span> <span class="mf">1024.0</span> <span class="o">*</span> <span class="mf">1024.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__gzip</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="SnapToBucket.update_proxy"><a class="viewcode-back" href="../../snap_to_bucket.snap_handler.html#snap_to_bucket.snap_handler.SnapToBucket.update_proxy">[docs]</a>    <span class="k">def</span> <span class="nf">update_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noproxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the http_proxy and no_proxy environment variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;http_proxy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s1">&#39;HTTP_PROXY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HTTP_PROXY&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;https_proxy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s1">&#39;HTTPS_PROXY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HTTPS_PROXY&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noproxy</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;no_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noproxy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;no_proxy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s1">&#39;NO_PROXY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;no_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NO_PROXY&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;no_proxy&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s2">&quot;169.254.169.254&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;no_proxy&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;no_proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;no_proxy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,169.254.169.254&quot;</span></div>

<div class="viewcode-block" id="SnapToBucket.update_split_size"><a class="viewcode-back" href="../../snap_to_bucket.snap_handler.html#snap_to_bucket.snap_handler.SnapToBucket.update_split_size">[docs]</a>    <span class="k">def</span> <span class="nf">update_split_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the split size of tar</span>

<span class="sd">        :param split: New split size</span>
<span class="sd">        :type split: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__split_size</span> <span class="o">=</span> <span class="n">split</span></div>

<div class="viewcode-block" id="SnapToBucket.perform_gzip"><a class="viewcode-back" href="../../snap_to_bucket.snap_handler.html#snap_to_bucket.snap_handler.SnapToBucket.perform_gzip">[docs]</a>    <span class="k">def</span> <span class="nf">perform_gzip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the flag to compress tar with gzip</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__gzip</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SnapToBucket.initiate_migration"><a class="viewcode-back" href="../../snap_to_bucket.snap_handler.html#snap_to_bucket.snap_handler.SnapToBucket.initiate_migration">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The brains of the process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span> <span class="o">=</span> <span class="n">Ec2Handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_type</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">__verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s3handler</span> <span class="o">=</span> <span class="n">S3Handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__split_size</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">__gzip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__storage_class</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">__verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span> <span class="o">=</span> <span class="n">FsHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mount_point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__verbose</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mount_point</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__restore</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__restore_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;missing key argument for restore&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__restore_snapshot</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find snapshots with tag:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="si">}</span><span class="s2">, value:migrate&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing snapshot &#39;</span><span class="si">{</span><span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">volumeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_attach_volume</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">mount_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">get_mounted_disc_size</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__move_data</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error occurred during S3 upload for snapshot &#39;&quot;</span> <span class="o">+</span>
                      <span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume &#39;</span><span class="si">{</span><span class="n">volumeid</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">unmount_volume</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">detach_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">delete_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">unmount_volume</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">detach_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">delete_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delete_snap</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">update_snapshot_tag</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed snapshot &#39;</span><span class="si">{</span><span class="n">snapshot</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">__create_attach_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and attach a new volume from given snapshot</span>

<span class="sd">        :param snap: Snapshot to be mounted</span>
<span class="sd">        :type snap: dict()</span>

<span class="sd">        :return: Newly created volume ID</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volumeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">attach_volume</span><span class="p">(</span><span class="n">volumeid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">volumeid</span>

    <span class="k">def</span> <span class="nf">__move_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload the data from snapshot to S3</span>

<span class="sd">        :param snapshot: Snapshot to be uploaded</span>
<span class="sd">        :type snapshot: dict()</span>
<span class="sd">        :param size: Size of the mounted partition</span>
<span class="sd">        :type size: integer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s3handler</span><span class="o">.</span><span class="n">initiate_upload</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mount_point</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__restore_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore the snapshot from S3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">no_of_objects</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s3handler</span><span class="o">.</span><span class="n">get_object_count_and_size</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__restore_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_of_objects</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">volume_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">create_empty_volume</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">attach_volume</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">prepare_volume</span><span class="p">(</span><span class="n">volume_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__restore_boot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">mount_volume</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_of_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s3handler</span><span class="o">.</span><span class="n">download_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__restore_key</span><span class="p">,</span>
                                                          <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">untar</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">no_of_objects</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s3handler</span><span class="o">.</span><span class="n">download_key</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__restore_key</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">untar</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">terminate_tar</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__restore_boot</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">update_fstab</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">mount_required_folders</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">update_grub</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">unmount_volume</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">unmount_required_folders</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fshandler</span><span class="o">.</span><span class="n">unmount_volume</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ec2handler</span><span class="o">.</span><span class="n">detach_volume</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">snap_to_bucket</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../snap_to_bucket.html">snap_to_bucket package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setupmigrate.html">Migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recovery.html">Recovery</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Siemens AG.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>